<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VPN Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#07102a;
      --card:#07132a;
      --glass:rgba(255,255,255,0.06);
      --accent:#7b89ff;
      --accent-2:#5be7c4;
      --text:#e8f0ff;
    }
    html,body{height:100%;margin:0;font-family:'Montserrat',system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    #lava-canvas{position:fixed;inset:0;width:100%;height:100%;z-index:0;pointer-events:none;filter:blur(18px) brightness(1.05) saturate(1.15);}
    .wrap{position:relative;z-index:1;min-height:100vh;padding:42px 18px;display:flex;flex-direction:column;align-items:center;}
    header{width:100%;max-width:980px;text-align:center;margin-bottom:18px;}
    h1{font-size:1.9rem;margin:6px 0 18px;letter-spacing:0.6px}
    .subtitle{opacity:0.8;margin-bottom:18px}
    .plans{width:100%;max-width:980px;display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:22px;align-items:stretch}
    .plan{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:18px;padding:22px;border:1px solid rgba(255,255,255,0.035);box-shadow:0 6px 30px rgba(3,8,30,0.45);cursor:pointer;transition:transform .18s,box-shadow .18s,opacity .12s;display:flex;flex-direction:column;justify-content:space-between}
    .plan:hover{transform:translateY(-6px);box-shadow:0 18px 50px rgba(6,12,40,0.6)}
    .plan .title{font-weight:700;font-size:1.15rem;color:var(--text);text-align:center}
    .plan .price{font-weight:800;font-size:1.45rem;color:var(--accent);text-align:center;margin-top:8px}
    .plan .desc{font-size:.95rem;color:#b9cbff;text-align:center;margin-top:10px}
    .plan .meta{display:flex;justify-content:center;gap:10px;margin-top:14px;color:#9fb7ff;opacity:0.9}
    .glass-btn{margin-top:18px;border-radius:12px;padding:12px 16px;background:linear-gradient(90deg,var(--accent),#6ad3ff);color:#061133;font-weight:800;border:none;cursor:pointer;box-shadow:0 8px 30px rgba(124,137,255,0.18)}
    .footer{margin-top:26px;color:#9fb7ff;opacity:0.9;font-size:0.95rem;text-align:center}
    .close{background:transparent;border:none;color:#9fb7ff;text-decoration:underline;margin-top:18px;cursor:pointer}
    @media (max-width:480px){h1{font-size:1.4rem}.plan .price{font-size:1.2rem}}
  </style>
</head>
<body>
  <canvas id="lava-canvas"></canvas>
  <div class="wrap">
    <header>
      <h1>↓ Выберите план ↓</h1>
      <div class="subtitle">Безопасный VPN — оплати и получи доступ мгновенно</div>
    </header>

    <div class="plans" role="list">
      <div class="plan" role="listitem" onclick="choosePlan('Basic',5)">
        <div>
          <div class="title">Basic</div>
          <div class="price">$5</div>
          <div class="desc">1 месяц</div>
          <div class="meta"><span>Поддержка 24/7</span></div>
        </div>
        <button class="glass-btn">Выбрать</button>
      </div>

      <div class="plan" role="listitem" onclick="choosePlan('Premium',10)">
        <div>
          <div class="title">Premium</div>
          <div class="price">$10</div>
          <div class="desc">3 месяца</div>
          <div class="meta"><span>Поддержка 24/7</span><span>Приоритетный сервер</span></div>
        </div>
        <button class="glass-btn">Выбрать</button>
      </div>

      <div class="plan" role="listitem" onclick="choosePlan('Ultimate',15)">
        <div>
          <div class="title">Ultimate</div>
          <div class="price">$15</div>
          <div class="desc">12 месяцев</div>
          <div class="meta"><span>Поддержка 24/7</span><span>Неограниченные устройства</span><span>Приоритетный сервер</span></div>
        </div>
        <button class="glass-btn">Выбрать</button>
      </div>
    </div>

    <button class="close" onclick="Telegram.WebApp.close()">Close App</button>
    <div class="footer">Powered by Telegram Mini App • Безопасные платежи</div>
  </div>

  <script>
    // Лёгкая анимация "lava"
    const canvas = document.getElementById('lava-canvas');
    const ctx = canvas.getContext('2d');
    let W = innerWidth, H = innerHeight, blobs = [];
    function resize(){ W = innerWidth; H = innerHeight; canvas.width=W; canvas.height=H; blobs=[]; for(let i=0;i<7;i++){ const r=80+Math.random()*120; blobs.push({x:Math.random()*W,y:Math.random()*H,r,dx:(Math.random()-0.5)*1.2,dy:(Math.random()-0.5)*1.2,color:`hsl(${200+Math.random()*60},70%,${20+Math.random()*20}%)`}); } }
    resize(); addEventListener('resize', resize);
    function draw(){
      ctx.clearRect(0,0,W,H);
      for(const b of blobs){
        const g = ctx.createRadialGradient(b.x,b.y,b.r*0.1,b.x,b.y,b.r);
        g.addColorStop(0, b.color);
        g.addColorStop(1, 'rgba(5,8,25,0)');
        ctx.fillStyle = g;
        ctx.beginPath();
        ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
        ctx.fill();
      }
    }
    function tick(){
      for(const b of blobs){ b.x+=b.dx; b.y+=b.dy; if(b.x-b.r<0||b.x+b.r>W) b.dx*=-1; if(b.y-b.r<0||b.y+b.r>H) b.dy*=-1; }
      draw(); requestAnimationFrame(tick);
    }
    tick();

    const tg = window.Telegram && Telegram.WebApp ? Telegram.WebApp : null;
    if(tg){ try{ tg.ready(); }catch(e){} }

    function choosePlan(name, price){
      const initData = (tg && tg.initData) ? tg.initData : '';
      fetch('/api/order', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ plan: name, price: price, initData: initData })
      }).then(async res=>{
        let j = null;
        try{ j = await res.json(); }catch(e){}
        if(res.ok && j && j.ok){
          try{ tg && tg.showAlert && tg.showAlert('Ссылка на оплату отправлена в чат.'); }catch(e){ alert('Ссылка на оплату отправлена.'); }
        } else {
          const err = j && j.error ? j.error : (j ? JSON.stringify(j) : 'server error');
          try{ tg && tg.showAlert && tg.showAlert('Ошибка создания платежа: ' + err); }catch(e){ alert('Ошибка создания платежа: ' + err); }
        }
      }).catch(err=>{
        try{ tg && tg.showAlert && tg.showAlert('Сетевая ошибка: ' + (err && err.message ? err.message : err)); }catch(e){ alert('Сеть: ' + (err && err.message ? err.message : err)); }
      });
    }

    // Поддержка кнопок внутри карточки (делегирование для клика по карточке)
    document.querySelectorAll('.plan').forEach(p=>{
      p.addEventListener('click', e=>{
        const title = p.querySelector('.title').textContent.trim();
        const priceText = p.querySelector('.price').textContent.replace('$','').trim();
        choosePlan(title, Number(priceText));
      });
    });
  </script>
</body>
</html>
