<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>VPN Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>body{font-family:Arial,Helvetica,sans-serif;background:#07102a;color:#fff;padding:24px;}</style>
</head>
<body>
  <h1>↓ Выбери план ↓</h1>
  <div>
    <button onclick="choose('Basic',5)">Basic — $5</button>
    <button onclick="choose('Premium',10)">Premium — $10</button>
    <button onclick="choose('Ultimate',15)">Ultimate — $15</button>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) try { tg.ready(); } catch(e){}

    async function choose(plan, price){
      const payload = {
        plan, price,
        initData: (Telegram && Telegram.WebApp && Telegram.WebApp.initData) ? Telegram.WebApp.initData : ''
      };

      // локальный POST на ваш сервер
      try {
        const res = await fetch('/api/order', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await res.json();
        if (res.ok && j.ok) {
          try { Telegram.WebApp.showAlert('Ссылка на оплату отправлена в чат.'); } catch(e){ alert('Ссылка отправлена.'); }
        } else {
          const err = j && j.error ? j.error : 'server_error';
          try { Telegram.WebApp.showAlert('Ошибка: ' + err); } catch(e){ alert('Ошибка: ' + err); }
        }
      } catch (e){
        try { Telegram.WebApp.showAlert('Сетевая ошибка: ' + e.message); } catch(err){ alert('Сетевая ошибка'); }
      }

      // опционально отправляем sendData (не обязателен при fallback)
      try { Telegram.WebApp.sendData(JSON.stringify({plan, price})); } catch(e){}
    }
  </script>
</body>
</html>
